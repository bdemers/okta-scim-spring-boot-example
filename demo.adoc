:experimental:
:commandkey: &#8984;
:toc: macro
:source-highlighter: highlight.js

= Add Apache SCIMple to your Spring Boot App

Today, I'll show you how to build a JHipster app that's uses OAuth and OIDC for authentication and Apache SCIMple to keep users in sync.

**Prerequisites**:

- https://sdkman.io/[Java] 17+
- https://nodejs.com/[Node.js] 16+

toc::[]

== Configure Okta for SCIM

. https://twitter.com/jf[JoÃ«l] is awesome! Start with his https://developer.okta.com/blog/2021/09/01/flask-scim-server#option-1-scim-template-app[create a SCIM Template App].

== Create a Spring Boot app with JHipster

. Install JHipster nightly:
+
[source,shell]
----
git clone -b spring-boot-3.0-m4 git@github.com:jhipster/jhipster-bom.git
cd jhipster-bom && ./mvnw install -Dgpg.skip=true && cd ..
git clone -b spring-boot-3.0-m4 https://github.com/jhipster/generator-jhipster.git
cd generator-jhipster && npm link
----

. Create a new directory for your project and `cd` into it:
+
[source,shell]
----
take spring-boot-scimple
----

. Create a new project:
+
[source,shell]
----
jhipster jdl 21-points.jh
----

. Run it and make sure end-to-end tests pass:
+
[source,shell]
----
./gradlew
# open a new terminal window
npm run e2e
----

. Add Apache SCIMple dependencies
+
[source,groovy]
.build.gradle
----

implementation "org.apache.directory.scim:scim-server:${scimpleVersion}"
implementation "org.apache.directory.scim:scim-spring-boot-starter:${scimpleVersion}"
----
+
[source,groovy]
.settings.gradle
----
scimpleVersion=1.0.0-SNAPSHOT
----
+
If you're using Maven:
+
[source,xml]
----
<scimple.version>1.0.0-SNAPSHOT</scimple.version>
...
<dependency>
    <groupId>org.apache.directory.scim</groupId>
    <artifactId>scim-spring-boot-starter</artifactId>
    <version>${scimple.version}</version>
</dependency>
<dependency>
    <groupId>org.apache.directory.scim</groupId>
    <artifactId>scim-server</artifactId>
    <version>${scimple.version}</version>
</dependency>
----

. Create a `ScimUserService` class that implements `Repository<User>`: [`scim-userservice`]
+
[source,java]
----
import jakarta.annotation.PostConstruct;
import jakarta.ws.rs.core.Response;
import org.apache.directory.scim.core.repository.Repository;
import org.apache.directory.scim.core.repository.UpdateRequest;
import org.apache.directory.scim.core.schema.SchemaRegistry;
import org.apache.directory.scim.server.exception.UnableToCreateResourceException;
import org.apache.directory.scim.server.exception.UnableToUpdateResourceException;
import org.apache.directory.scim.spec.filter.Filter;
import org.apache.directory.scim.spec.filter.FilterExpressions;
import org.apache.directory.scim.spec.filter.FilterResponse;
import org.apache.directory.scim.spec.filter.PageRequest;
import org.apache.directory.scim.spec.filter.SortRequest;
import org.apache.directory.scim.spec.resources.Email;
import org.apache.directory.scim.spec.resources.Name;
import org.apache.directory.scim.spec.resources.ScimResource;
import org.apache.directory.scim.spec.resources.ScimUser;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * Creates a singleton (effectively) Provider<User> with a memory-based
 * persistence layer.
 *
 * @author Chris Harm &lt;crh5255@psu.edu&gt;
 */
@Service
public class ScimUserService implements Repository<ScimUser> {

    static final String DEFAULT_USER_ID = "1";
    static final String DEFAULT_USER_EXTERNAL_ID = "e" + DEFAULT_USER_ID;
    static final String DEFAULT_USER_DISPLAY_NAME = "User " + DEFAULT_USER_ID;
    static final String DEFAULT_USER_EMAIL_VALUE = "e1@example.com";
    static final String DEFAULT_USER_EMAIL_TYPE = "work";

    private final Map<String, ScimUser> users = new HashMap<>();

    private final SchemaRegistry schemaRegistry;

    public ScimUserService(SchemaRegistry schemaRegistry) {
        this.schemaRegistry = schemaRegistry;
    }

    @PostConstruct
    public void init() {
        ScimUser user = new ScimUser();
        user.setId(DEFAULT_USER_ID);
        user.setExternalId(DEFAULT_USER_EXTERNAL_ID);
        user.setUserName(DEFAULT_USER_EXTERNAL_ID);
        user.setDisplayName(DEFAULT_USER_DISPLAY_NAME);
        user.setName(new Name()
            .setGivenName("Tester")
            .setFamilyName("McTest"));
        Email email = new Email();
        email.setDisplay(DEFAULT_USER_EMAIL_VALUE);
        email.setValue(DEFAULT_USER_EMAIL_VALUE);
        email.setType(DEFAULT_USER_EMAIL_TYPE);
        email.setPrimary(true);
        user.setEmails(List.of(email));

        users.put(user.getId(), user);
    }

    @Override
    public Class<ScimUser> getResourceClass() {
        return ScimUser.class;
    }

    /**
     * @see Repository#create(ScimResource)
     */
    @Override
    public ScimUser create(ScimUser resource) throws UnableToCreateResourceException {
        String resourceId = resource.getId();
        int idCandidate = resource.hashCode();
        String id = resourceId != null ? resourceId : Integer.toString(idCandidate);

        while (users.containsKey(id)) {
            id = Integer.toString(idCandidate);
            ++idCandidate;
        }

        // check to make sure the user doesn't already exist
        boolean existingUserFound = users.values().stream()
            .anyMatch(user -> user.getUserName().equals(resource.getUserName()));
        if (existingUserFound) {
            // HTTP leaking into data layer
            throw new UnableToCreateResourceException(Response.Status.CONFLICT, "User '" + resource.getUserName() + "' already exists.");
        }

        resource.setId(id);
        users.put(id, resource);
        return resource;
    }

    /**
     * @see Repository#update(UpdateRequest)
     */
    @Override
    public ScimUser update(UpdateRequest<ScimUser> updateRequest) throws UnableToUpdateResourceException {
        String id = updateRequest.getId();
        ScimUser resource = updateRequest.getResource();
        users.put(id, resource);
        return resource;
    }

    /**
     * @see Repository#get(java.lang.String)
     */
    @Override
    public ScimUser get(String id) {
        return users.get(id);
    }

    /**
     * @see Repository#delete(java.lang.String)
     */
    @Override
    public void delete(String id) {
        users.remove(id);
    }

    /**
     * @see Repository#find(Filter, PageRequest, SortRequest)
     */
    @Override
    public FilterResponse<ScimUser> find(Filter filter, PageRequest pageRequest, SortRequest sortRequest) {

        long count = pageRequest.getCount() != null ? pageRequest.getCount() : users.size();
        long startIndex = pageRequest.getStartIndex() != null
            ? pageRequest.getStartIndex() - 1 // SCIM is 1-based indexed
            : 0;

        List<ScimUser> result = users.values().stream()
            .skip(startIndex)
            .limit(count)
            .filter(FilterExpressions.inMemory(filter, schemaRegistry.getSchema(ScimUser.SCHEMA_URI)))
            .collect(Collectors.toList());

        return new FilterResponse<>(result, pageRequest, result.size());
    }
}
----

. Create a `ScimGroupService` class that implements `Repository<Group>`: [`scim-groupservice`]

[source,java]
----
import com.okta.developer.repository.AuthorityRepository;
import java.util.List;
import java.util.stream.Collectors;
import org.apache.directory.scim.core.repository.Repository;
import org.apache.directory.scim.core.repository.UpdateRequest;
import org.apache.directory.scim.core.schema.SchemaRegistry;
import org.apache.directory.scim.spec.exception.ResourceException;
import org.apache.directory.scim.spec.filter.Filter;
import org.apache.directory.scim.spec.filter.FilterExpressions;
import org.apache.directory.scim.spec.filter.FilterResponse;
import org.apache.directory.scim.spec.filter.PageRequest;
import org.apache.directory.scim.spec.filter.SortRequest;
import org.apache.directory.scim.spec.resources.Email;
import org.apache.directory.scim.spec.resources.Name;
import org.apache.directory.scim.spec.resources.ScimGroup;
import org.apache.directory.scim.spec.resources.ScimUser;
import org.apache.directory.scim.spec.schema.ResourceReference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

@Service
public class ScimGroupService implements Repository<ScimGroup> {

    private final Logger log = LoggerFactory.getLogger(ScimGroupService.class);

    private final AuthorityRepository authorityRepository;

    private final SchemaRegistry schemaRegistry;

    @Override
    public Class<ScimGroup> getResourceClass() {
        return ScimGroup.class;
    }

    public ScimGroupService(AuthorityRepository authorityRepository, SchemaRegistry schemaRegistry) {
        this.authorityRepository = authorityRepository;
        this.schemaRegistry = schemaRegistry;
    }

    @Override
    public ScimGroup create(ScimGroup scimGroup) throws ResourceException {
        // check if authority exists
        log.debug("check if authority exists, if not, create");
        return scimGroup;
    }

    @Override
    public ScimGroup update(UpdateRequest<ScimGroup> updateRequest) throws ResourceException {
        log.debug("todo: updating");
        return updateRequest.getResource();
    }

    @Override
    public ScimGroup get(String s) throws ResourceException {
        // who the hell knows
        log.debug("get() with {}", s);
        return new ScimGroup();
    }

    @Override
    public FilterResponse<ScimGroup> find(Filter filter, PageRequest pageRequest, SortRequest sortRequest) {
        log.debug("filter: {}, page: {}, sort: {}", filter, pageRequest, sortRequest);
        // todo: use filters and paging/sorting

        long count = pageRequest.getCount() != null ? pageRequest.getCount() : authorityRepository.count();
        long startIndex = pageRequest.getStartIndex() != null
            ? pageRequest.getStartIndex() - 1 // SCIM is 1-based indexed
            : 0;

        List<ScimGroup> result = authorityRepository
            .findAll()
            .stream()
            .map(authority -> {
                ScimGroup scimGroup = new ScimGroup();
                scimGroup.setDisplayName(authority.getName());
                return scimGroup;
            })
            .skip(startIndex)
            .limit(count)
            .filter(FilterExpressions.inMemory(filter, schemaRegistry.getSchema(ScimGroup.SCHEMA_URI)))
            .collect(Collectors.toList());

        return new FilterResponse<>(result, pageRequest, result.size());
    }

    @Override
    public void delete(String s) throws ResourceException {
        log.debug("delete...");
    }
}
----

. Turn down logging from Jersey and JAXB:

[source,xml]
.src/main/resources/logback-spring.xml
----
<logger name="org.glassfish" level="WARN"/>
----

. Configure Spring to serve up Jersey endpoint at `/scim`:

[source,yaml]
.src/main/resources/config/application.yml
----
jersey:
    application-path: /scim
----

. Update `SecurityConfiguration` to skip CSRF for Jersey endpoints:
+
[source,java]
.src/main/java/com/okta/developer/config/SecurityConfiguration.java
----
http
    .csrf()
    .ignoringAntMatchers("/h2-console/**", "/scim/**")
----

. Enable CORS for `/scim/**`.
+
[source,java]
.src/main/java/com/okta/developer/config/WebConfigurer.java
----
source.registerCorsConfiguration("/scim/**", config);
----

. Update `AccountResource#getAccount()` to get user from database:
+
[source,java]
----
String email =
    ((OAuth2AuthenticationToken) principal).getPrincipal()
        .getAttributes()
        .getOrDefault("email", "")
        .toString()
        .toLowerCase(Locale.ROOT);
Optional<User> user = userService.getUserWithAuthoritiesByLogin(email);
----

== Test syncing identities

. Start ngrok and confirm URL works from Okta SCIM test app:

[source,shell]
----
ngrok http 8080
----

// todo: protect the SCIM endpoints with Spring Security
